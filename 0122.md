# JPA 양방향 매핑
## 테이블의 연관관계
- DubDub의 ERD의 `모집글`과 `배역`테이블
  - `배역`테이블의 field에는 모집글id(PK)가 FK로 존재한다.
  - `모집글`테이블에는 배역과 관련된 field가 존재하지 않는다.
- 하나의 모집글는 여러 배역을 가질 수 있음 (1:N)
- `@OneToMany`는 mappedBy로 연관관계의 주인을 지정 
- `@ManyToOne`이 있는 배역이 연관관계의 주인(외래키 관리)
- 양방향이므로 데이터 저장시 양쪽 모두 값을 설정해야 한다.

# JWT 인가과정
- Json 포맷을 이용하여, 인증에 필요한 정보들을 **암호화시킨 Json 토큰**

### JWT 구조

- Header / Payload / Signature 구조
  - Header : 토큰의 타입, 해싱 알고리즘

      ```json
      {
          "alg": "암호활 할 해싱 알고리즘",
          "typ": "토큰의 타입(JWT)"
      }
      ```

  - Payload : 하나의 정보 Claim(s) = 사용자 정보 ex. name

      ```json
      {
          /*등록된 claim : 미리 선언된 애들*/
          "iss": "토큰 발급자"
          "sub": "토큰 제목",
          "aud": "토큰 대상자",
          "exp": "토큰 만료시간"
          "nbf": "Not before, 해당 날짜가 지나기 전까지는 토큰이 처리되지 않는다.",
          "iat": "토큰이 발급된 시간",
          "jti": "JWT 고유 식별자, 중복적인 처리를 방지하기 위해 사용",
          /*공개 claim : IANA(Internet Assigned Numbers Authority)에 등록되어 있거나 등록할 수 있는 claim*/
          "name": "",
          "email" : "",
          /*비공개 claim : 클라이언트와 서버 협의 하에 특정 정보를 공유하기 위해 사용되는 커스텀 클레임*/
          "memberId": "",
      }
      ```

  - Signature : 서명(암호화)한 값

### 인증 / 인가 과정

1. 인증된 사용자에게 Access Token과 Refresh Token을 발급한다.
  1. 클라이언트는 Access Token을 사용(HTTP Header에 담아서)해서 서버의 인가를 포함한 요청을 보낼 수 있다.
2. Access Token의 유효시간은 짧게 주어진다. 생명주기가 끝나게 되면, Access Token을 갱신하기 위해 Refresh Token을 사용하게 된다.
  1. 생명주기가 끝난 Access Token이 요청으로 들어오면, 서버는 만료를 응답한다.
  2. 만료된 Access Token과 Refresh Token을 다시 담아서(Body) 토큰 갱신을 요청 후 Access Token을 발급 받는다.
3. Access Token보다 유효기간이 길지만, Refresh Token이 만료된다면, 로그아웃된다.
  1. Refresh Token도 갱신하는 **RTR 방식**도 존재한다.